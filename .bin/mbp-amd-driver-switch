#!/usr/bin/env bash

input="${1/--/}"
radeon_on="radeon.si_support=1 amdgpu.si_support=0"
amdgpu_on="radeon.si_support=0 amdgpu.si_support=1"

switch-driver() {
    sudo grubby \
	 --remove-args="$1" \
	 --args="$2" \
	 --update-kernel=ALL
}

current() {
    lspci -k | grep -iE 'kernel driver in use: (radeon|amdgpu)'
}

usage() {
    echo "Usage: ${0##*/} [--switch|--current]"
}

case "$input" in
    current)
	eval "$input"
	;;
    switch)
	if lspci -k | grep -qi 'kernel driver in use: amdgpu'; then
	    switch-driver "$amdgpu_on" "$radeon_on"
	    echo "Will use iGPU"
	else
	    switch-driver "$radeon_on" "$amdgpu_on"
	    echo "Will use dGPU"
	fi
	;;
    *)
	usage
esac

