#!/usr/bin/env bash

##################################################################################
# Launch instances of ungoogled-chromium separated by HOME directories		 #
#										 #
# ungoogled-chromium <home-dir-name|cloudshare|incognito> <args>		 #
#										 #
# must be called with a DIRECTORY name as the first argument, but will		 #
# treat any first argument as a directory name so be careful. Upon launch	 #
# proceeds with these steps:							 #
#										 #
# 1. checks if the directory is called 'temp', and sets the $home var based on	 #
#    this									 #
# 2. checks if the home directory exists, creating it if it doesn't		 #
# 3a. based on the home directory name, calls ungoogled-chromium with a		 #
#     home directory in either the PARENT directory, under a SUB directory, or	 #
#     in /tmp with a unique name						 #
# 3b. if 'incognito' is passed as the name, launches ungoogled-chromium with the #
#     --incognito flag								 #
##################################################################################
set -x
input="$@"

ungoogled-chromium() {
    set +x
    local input=( $@ )
    local sdir="${input[0]}"
    local args=( ${input[@]:1:${#input[@]}} )
    local pdir="$HOME/.ungoogled-chromium"
    local tdir="ungoogled-chromium-${sdir}"
    local home
    local rand="$(openssl rand -hex 16)"
    local flatpak="$(flatpak list --columns=application | grep -iE '^.*ungoogledchromium$')"
    # limit the $PATH so we don't call this wrapper, and get path to binary
    local package="PATH='/usr/bin:/usr/local/bin' $(which ungoogled-chromium)"

    _set-home() {
	set +x
	case "$sdir" in
	    incognito|temp)
		home="/tmp/${tdir}-${rand}" ;;
	    *)
		home="${pdir}/${sdir}"
	esac
	set -x
    }

    _populate-home() {
	set +x
	case "$sdir" in
	    incognito)
		mkdir -p "$home" ;;
	    temp)
		cp -a  "${pdir}/template-cloudshare" "$home" ;;
	    *)
		if [[ ! -d "$home" ]]; then
		    cp -a ${pdir}/template-${sdir}/ "$home"
		fi
	esac
	set -x
    }

    _ungoogled-chromium() {
	set -x
	local -a input=( $@ )
	
	if [[ -n "$flatpak" ]]; then
	    env HOME="$home" flatpak run --filesystem=$HOME/Downloads "$flatpak" "${input[@]}"
	else
	    # what args need to be here to have distinct working directories?
	    "$package" "${input[@]}"
	fi
	set +x
    }

    _run-chromium() {
	set -x
	_set-home
	_populate-home
	case "$sdir" in
	    incognito)
		_ungoogled-chromium --incognito "${args[@]}" ;;
	    *)
		_ungoogled-chromium "${args[@]}"
	esac
	set +x
    }

    _run-chromium
    set +x
}

ungoogled-chromium "$input"
set +x
