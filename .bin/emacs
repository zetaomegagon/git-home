#!/usr/bin/env bash

is-term-p() {
    shopt -s extglob
    
    if [[ $TERM == ?(tmu)x?(term)* ]]; then
	return 0
    else
	return 1
    fi
}

emacs() {
    set -x

    source "$HOME/.bashrc.d/12-emacs.rc"

    local is_term_flag finput
    local -a flags
    readarray finput < <(printf -- "$*")
    
    flags=(
	"--display=${DISPLAY:-$WAYLAND_DISPLAY}"
	"--socket-name=$XDG_RUNTIME_DIR/emacs/server"
    )

    emacs-dead-p && emacsctl start

    if is-term-p; then
	flags+=("--tty")
    else
	flags+=("--reuse-frame")
    fi

    if [[ -z $finput ]]; then
	command emacsclient ${flags[@]}
    else
	command emacsclient ${flags[@]} ${finput[@]}
    fi
    
    set +x
} 

declare log input

if is-term-p; then
    log="emacs-term.log"
else
    log="emacs-gui.log"
fi

readarray input < <(printf -- "$*")

emacs "${input[@]}" 2>"$HOME/.emacs.d/$log"

exit 0
